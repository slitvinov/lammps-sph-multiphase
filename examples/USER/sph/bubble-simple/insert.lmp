echo               both
log                ${dname}/log.lammps
units              si
atom_style         meso


#variable          ndim equal 3 
dimension         ${ndim}
if ${ndim}==3 then &
"boundary          p p p" &
else &
"boundary          p p p"

include           vars.lmp

# create simulation box
variable           xcenter equal 0.5*${Lx}
variable           ycenter equal 0.5*${Ly}
if ${ndim}==3 then &
"variable           zcenter equal 0.5*${Lz}" &
else &
"variable           zcenter equal 0.0" &

if ${ndim}==2 then &
"variable           pLz    equal  1.0e-3" &
"variable           nLz    equal  -1.0e-3" &
"region             box block 0.0 ${Lx}  0.0 ${Ly} ${nLz} ${pLz} units box" &
else &
"region             box block 0.0 ${Lx}  0.0 ${Ly} 0.0 ${Lz} units box"

# create box with two types of particles (water, gas)
create_box         2 box

# create gas particles
variable lshift    equal 0.5
if ${ndim}==2 then &
"lattice            sq ${dx} origin ${lshift} ${lshift} 0" &
else &
"lattice            sc ${dx} origin ${lshift} ${lshift} ${lshift}"

create_atoms       ${g_type} region box

# create walls on the top and on the bottom
variable     x1  equal 3*${dx}
variable     x2  equal ${Lx}-3*${dx}
variable     y1 equal 3*${dx}
variable     y2  equal ${Ly}-3*${dx}
if ${ndim}==3 then &
"variable     z1 equal 3*${dx}" &
"variable     z2  equal ${Lz}-3.0*${dx}" &
"region	     rflow block ${x1} ${x2} ${y1} ${y2} ${z1} ${z2} units box" &
else &
"region	     rflow block ${x1} ${x2} ${y1} ${y2} EDGE EDGE units box"

group	     flow region rflow
group	     boundary subtract all flow
#fix          wallim boundary setforce 0 0 0

# do full time integration for all particles
fix                integrate_fix_full all meso

#include            ${ndim}-image.lmp
variable           sph_mu  equal ${sph_eta_d}/${sph_rho_d}
include            settimestep.lmp

neighbor           0 bin
neigh_modify       delay 0 every 1
communicate        single vel yes

pair_style         hybrid/overlay sph/rhosum_multiphase 1 sph/colorgradient 1 &
                   sph/taitwater/morris sph/surfacetension sph/heatconduction/phasechange
pair_coeff         * * sph/rhosum_multiphase   ${h}
pair_coeff         ${d_type} ${d_type} sph/colorgradient ${h} 0
pair_coeff         ${g_type} ${d_type} sph/colorgradient ${h} ${alpha}
pair_coeff         ${g_type} ${g_type} sph/colorgradient ${h} 0

variable           sph_eta_gd equal 2*${sph_eta_g}*${sph_eta_d}/(${sph_eta_d}+${sph_eta_g})
pair_coeff         ${g_type} ${d_type} sph/taitwater/morris ${sph_rho_g} ${sph_c_g} ${sph_eta_gd} 7.0 ${h} ${rbackground}
pair_coeff         ${g_type} ${g_type} sph/taitwater/morris ${sph_rho_g} ${sph_c_g}  ${sph_eta_g} 7.0 ${h} ${rbackground}
pair_coeff         ${d_type} ${d_type} sph/taitwater/morris ${sph_rho_d} ${sph_c_d}  ${sph_eta_d} 7.0 ${h} ${rbackground}

pair_coeff         * * sph/surfacetension ${h}
pair_coeff         ${g_type} ${g_type} sph/heatconduction/phasechange  ${D_heat_g} ${h}
variable           D_heat_gd equal 2*${D_heat_g}*${D_heat_d}/(${D_heat_d}+${D_heat_g})
pair_coeff         ${g_type} ${d_type} sph/heatconduction/phasechange  ${D_heat_gd} ${h} NULL ${Tc}
pair_coeff         ${d_type} ${d_type} sph/heatconduction/phasechange  ${D_heat_d} ${h}

dump               dump_xyz all xyz ${Nfreq} ${dname}/data.xyz
dump_modify        dump_xyz element A B

timestep           ${dt}
variable           insert_every equal 1
#variable          Hwv equal 0.00
variable           dr equal 0.5*${dx}
variable           prob equal ${dprob}

variable            time equal step*${dt}
variable            natoms equal count(all)

#create vapor atom in the center of the domain
variable          xcenter_per equal ${xcenter}
variable          ycenter_per equal ${ycenter}
create_atoms      ${d_type} single  ${xcenter_per} ${ycenter_per} ${zcenter} units box

# region            rsq sphere ${xcenter} ${ycenter} ${zcenter} 0.05 units box
# set               region rsq type ${d_type}

# variable          a_sq   equal 0.2
# include           square.lmp
# set               region rsq type ${d_type}

set               type ${d_type} meso_cv ${cv_d}
set               type ${g_type} meso_cv ${cv_g}
set               type ${d_type} meso_e ${e_d}
set               type ${g_type} meso_e ${e_g}
set               type ${d_type} mass ${sph_mass_d}
set               type ${g_type} mass ${sph_mass_g}
set               type ${d_type} meso_rho ${sph_rho_d}
set               type ${g_type} meso_rho ${sph_rho_g}

group              droplet type ${d_type}


compute            rho_peratom all meso_rho/atom
compute            colorgradient_peratom all meso_colorgradient/atom
compute         it_atom all meso_t/atom
compute         ie_atom all meso_e/atom
compute         ie all reduce sum c_ie_atom
variable        vie equal c_ie
variable        volume atom mass/c_rho_peratom
compute         dvol droplet reduce sum v_volume
variable        vvol equal c_dvol
compute         ied droplet reduce sum c_ie_atom
variable        vied equal c_ied
variable        vdroplet equal count(droplet)
variable        vnd equal count(droplet)*${dx}^${ndim}
fix extra all print 1 "${time} ${vnd} ${vie} ${vied} ${vvol} ${vdroplet}" file ${dname}/rg.dat screen no

dump               dump_id all custom ${Nfreq} ${dname}/dump*.dat id type x y z vx vy vz &
                                                                  c_rho_peratom c_ie_atom c_it_atom
dump_modify        dump_id first yes sort id pad 8

thermo_style        custom step v_time v_natoms v_vnd
thermo              10

variable           pcutoff equal ${h}
fix                fdep droplet phase_change &
                   ${Tc} ${Tt} ${Hwv} ${dr} ${sph_mass_d} &
                   ${pcutoff} ${g_type} ${d_type} ${insert_every} 123456 ${prob} region box units box

# outside of this sphere the temperature is 1.0
variable          Rtemp equal ${xcenter}-2.6*${dx}
region            rtemp sphere ${xcenter} ${ycenter} ${zcenter} ${Rtemp} units box

echo              log
variable          nstep equal 10.0/${dt}
group gflow region rtemp
fix smeso      all setmeso meso_t ${Tinf} noregion rtemp

run               ${nstep}
